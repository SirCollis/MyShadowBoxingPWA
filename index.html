<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadow Boxing App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Force full viewport height for both html and body elements */
        html, body {
            height: 100%;
        }
        /* Apply the light background and use Tailwind classes for layout */
        body {
            background-color: #f3f4f6; /* Light gray */
            font-family: 'Roboto Mono', monospace;
            @apply text-slate-900 flex items-center justify-center min-h-screen p-4;
        }
        .container {
            @apply max-w-4xl w-full p-8 rounded-xl shadow-lg border-2 border-gray-300 bg-white;
        }
        .level-button {
            @apply w-full py-4 px-6 text-xl font-bold rounded-full transition-all duration-300 ease-in-out transform;
        }
        .button-selected {
            box-shadow: 0 0 10px #f97316, 0 0 20px #f97316, 0 0 30px #f97316;
            @apply bg-orange-500 text-white;
        }
        .combo-display {
            text-shadow: 0 0 15px #22c55e, 0 0 30px #22c55e;
            font-size: 15vh;
            @apply font-bold;
        }
        .timer-display {
            font-size: 8vh;
            @apply font-bold;
        }
        .vibrant-button {
            @apply bg-indigo-600 text-white;
            transition: all 0.3s ease;
        }
        .vibrant-button:hover {
            box-shadow: 0 0 10px #6366f1, 0 0 20px #6366f1;
            @apply bg-indigo-500;
        }
        .back-button {
            @apply bg-zinc-400 text-zinc-900;
            transition: all 0.3s ease;
        }
        .back-button:hover {
            box-shadow: 0 0 10px #f97316, 0 0 20px #f97316;
            @apply bg-zinc-300;
        }
        .workout-history {
            max-height: 200px;
            overflow-y: auto;
            border-top: 2px solid #e5e7eb;
            margin-top: 2rem;
            padding-top: 1rem;
        }
        .modal {
            @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50;
        }
        .modal-content {
            @apply bg-white p-8 rounded-xl shadow-lg border-2 border-gray-300 max-w-sm w-full;
        }
    </style>
</head>
<body>

<!-- Main Menu Page -->
<div id="main-menu-page" class="container">
    <h1 class="text-4xl font-bold mb-6 text-center text-slate-900">Shadow Boxing App</h1>
    <p class="text-center mb-10 text-zinc-600">Select a level to begin your training.</p>

    <!-- Daily Streak Display -->
    <div class="flex justify-center items-center mt-6">
        <div class="text-center">
            <p class="text-2xl font-bold mb-2">Daily Streak</p>
            <p id="streak-display" class="text-5xl font-extrabold text-green-500">0</p>
            <p id="last-workout-date" class="text-sm text-gray-500 mt-2"></p>
        </div>
    </div>

    <div id="level-button-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
        <!-- Dynamically generated level buttons -->
    </div>

    <div class="workout-history">
        <h3 class="text-2xl font-bold mb-4">Your Past Workouts</h3>
        <div id="history-list">
            <!-- Workout history will be displayed here -->
        </div>
    </div>
</div>

<!-- Level 1 Page Content (Hidden by default) -->
<div id="level-1-page" class="container hidden">
    <h2 class="text-4xl font-bold mb-4 text-center">Level 1</h2>
    <p class="text-center text-xl sm:text-2xl text-zinc-600 mb-8">Punches: 1, 2, 3, 4, 5, 6</p>
    <div id="difficulty-buttons-1" class="flex flex-col sm:flex-row justify-center gap-4 mb-8">
        <button class="level-button vibrant-button" data-difficulty="easy">Easy</button>
        <button class="level-button vibrant-button" data-difficulty="normal">Normal</button>
        <button class="level-button vibrant-button" data-difficulty="hard">Hard</button>
    </div>
    <div id="timer-buttons-1" class="grid grid-cols-3 gap-4 mb-8">
        <button class="level-button vibrant-button" data-timer="30">30 Sec</button>
        <button class="level-button vibrant-button" data-timer="90">1:30</button>
        <button class="level-button vibrant-button" data-timer="120">2:00</button>
        <button class="level-button vibrant-button" data-timer="150">2:30</button>
        <button class="level-button vibrant-button" data-timer="180">3:00</button>
        <button class="level-button vibrant-button" data-timer="open">Open</button>
    </div>
    <div class="text-center combo-display mb-2" id="combo-display-1"></div>
    <div id="status-message-1" class="text-center text-zinc-500 mb-4 hidden"></div>
    <div class="text-center timer-display mb-4" id="timer-display-1"></div>

    <div class="flex flex-col sm:flex-row justify-center gap-8 mb-4">
        <div class="text-center">
            <p class="text-lg font-bold">Punches</p>
            <p id="punch-count-display-1" class="text-4xl font-extrabold text-orange-500">0</p>
        </div>
        <div class="text-center">
            <p class="text-lg font-bold">Movements</p>
            <p id="movement-count-display-1" class="text-4xl font-extrabold text-blue-500">0</p>
        </div>
    </div>

    <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8">
        <button id="start-button-1" class="level-button bg-orange-500 hover:bg-orange-400 hidden">Start</button>
        <button id="stop-button-1" class="level-button bg-red-600 hover:bg-red-500 hidden">Stop</button>
        <button id="back-button-1" class="level-button back-button">Back</button>
    </div>
    <div class="flex items-center justify-center gap-4 mt-4">
        <button id="speed-down-1" class="level-button vibrant-button">Slow Down</button>
        <span id="speed-display-1" class="text-xl font-bold">Speed: 1</span>
        <button id="speed-up-1" class="level-button vibrant-button">Speed Up</button>
    </div>
    <button id="save-button-1" class="level-button vibrant-button mt-4 hidden">Save Workout</button>
</div>

<!-- Level 2 Page Content (Hidden by default) -->
<div id="level-2-page" class="container hidden">
    <h2 class="text-4xl font-bold mb-4 text-center">Level 2</h2>
    <p class="text-center text-xl sm:text-2xl text-zinc-600 mb-8">Punches: 1-6 & Movements: SlipRight, SlipLeft, DuckUnder</p>
    <div id="difficulty-buttons-2" class="flex flex-col sm:flex-row justify-center gap-4 mb-8">
        <button class="level-button vibrant-button" data-difficulty="easy">Easy</button>
        <button class="level-button vibrant-button" data-difficulty="normal">Normal</button>
        <button class="level-button vibrant-button" data-difficulty="hard">Hard</button>
    </div>
    <div id="timer-buttons-2" class="grid grid-cols-3 gap-4 mb-8">
        <button class="level-button vibrant-button" data-timer="30">30 Sec</button>
        <button class="level-button vibrant-button" data-timer="90">1:30</button>
        <button class="level-button vibrant-button" data-timer="120">2:00</button>
        <button class="level-button vibrant-button" data-timer="150">2:30</button>
        <button class="level-button vibrant-button" data-timer="180">3:00</button>
        <button class="level-button vibrant-button" data-timer="open">Open</button>
    </div>
    <div class="text-center combo-display mb-2" id="combo-display-2"></div>
    <div id="status-message-2" class="text-center text-zinc-500 mb-4 hidden"></div>
    <div class="text-center timer-display mb-4" id="timer-display-2"></div>

    <div class="flex flex-col sm:flex-row justify-center gap-8 mb-4">
        <div class="text-center">
            <p class="text-lg font-bold">Punches</p>
            <p id="punch-count-display-2" class="text-4xl font-extrabold text-orange-500">0</p>
        </div>
        <div class="text-center">
            <p class="text-lg font-bold">Movements</p>
            <p id="movement-count-display-2" class="text-4xl font-extrabold text-blue-500">0</p>
        </div>
    </div>

    <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8">
        <button id="start-button-2" class="level-button bg-orange-500 hover:bg-orange-400 hidden">Start</button>
        <button id="stop-button-2" class="level-button bg-red-600 hover:bg-red-500 hidden">Stop</button>
        <button id="back-button-2" class="level-button back-button">Back</button>
    </div>
    <div class="flex items-center justify-center gap-4 mt-4">
        <button id="speed-down-2" class="level-button vibrant-button">Slow Down</button>
        <span id="speed-display-2" class="text-xl font-bold">Speed: 1</span>
        <button id="speed-up-2" class="level-button vibrant-button">Speed Up</button>
    </div>
    <button id="save-button-2" class="level-button vibrant-button mt-4 hidden">Save Workout</button>
</div>

<!-- Level 3 Page Content -->
<div id="level-3-page" class="container hidden">
    <h2 class="text-4xl font-bold mb-4 text-center">Level 3</h2>
    <p class="text-center text-xl sm:text-2xl text-zinc-600 mb-8">Punches: 1-10 & Movements: SlipRight, SlipLeft, DuckUnder</p>
    <div id="difficulty-buttons-3" class="flex flex-col sm:flex-row justify-center gap-4 mb-8">
        <button class="level-button vibrant-button" data-difficulty="easy">Easy</button>
        <button class="level-button vibrant-button" data-difficulty="normal">Normal</button>
        <button class="level-button vibrant-button" data-difficulty="hard">Hard</button>
    </div>
    <div id="timer-buttons-3" class="grid grid-cols-3 gap-4 mb-8">
        <button class="level-button vibrant-button" data-timer="30">30 Sec</button>
        <button class="level-button vibrant-button" data-timer="90">1:30</button>
        <button class="level-button vibrant-button" data-timer="120">2:00</button>
        <button class="level-button vibrant-button" data-timer="150">2:30</button>
        <button class="level-button vibrant-button" data-timer="180">3:00</button>
        <button class="level-button vibrant-button" data-timer="open">Open</button>
    </div>
    <div class="text-center combo-display mb-2" id="combo-display-3"></div>
    <div id="status-message-3" class="text-center text-zinc-500 mb-4 hidden"></div>
    <div class="text-center timer-display mb-4" id="timer-display-3"></div>

    <div class="flex flex-col sm:flex-row justify-center gap-8 mb-4">
        <div class="text-center">
            <p class="text-lg font-bold">Punches</p>
            <p id="punch-count-display-3" class="text-4xl font-extrabold text-orange-500">0</p>
        </div>
        <div class="text-center">
            <p class="text-lg font-bold">Movements</p>
            <p id="movement-count-display-3" class="text-4xl font-extrabold text-blue-500">0</p>
        </div>
    </div>

    <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8">
        <button id="start-button-3" class="level-button bg-orange-500 hover:bg-orange-400 hidden">Start</button>
        <button id="stop-button-3" class="level-button bg-red-600 hover:bg-red-500 hidden">Stop</button>
        <button id="back-button-3" class="level-button back-button">Back</button>
    </div>
    <div class="flex items-center justify-center gap-4 mt-4">
        <button id="speed-down-3" class="level-button vibrant-button">Slow Down</button>
        <span id="speed-display-3" class="text-xl font-bold">Speed: 1</span>
        <button id="speed-up-3" class="level-button vibrant-button">Speed Up</button>
    </div>
    <button id="save-button-3" class="level-button vibrant-button mt-4 hidden">Save Workout</button>
</div>

<!-- Level 4 Page Content -->
<div id="level-4-page" class="container hidden">
    <h2 class="text-4xl font-bold mb-4 text-center">Level 4</h2>
    <p class="text-center text-xl sm:text-2xl text-zinc-600 mb-8">Punches: 1-10 & Movements: Slip, Duck, Step</p>
    <div id="difficulty-buttons-4" class="flex flex-col sm:flex-row justify-center gap-4 mb-8">
        <button class="level-button vibrant-button" data-difficulty="easy">Easy</button>
        <button class="level-button vibrant-button" data-difficulty="normal">Normal</button>
        <button class="level-button vibrant-button" data-difficulty="hard">Hard</button>
    </div>
    <div id="timer-buttons-4" class="grid grid-cols-3 gap-4 mb-8">
        <button class="level-button vibrant-button" data-timer="30">30 Sec</button>
        <button class="level-button vibrant-button" data-timer="90">1:30</button>
        <button class="level-button vibrant-button" data-timer="120">2:00</button>
        <button class="level-button vibrant-button" data-timer="150">2:30</button>
        <button class="level-button vibrant-button" data-timer="180">3:00</button>
        <button class="level-button vibrant-button" data-timer="open">Open</button>
    </div>
    <div class="text-center combo-display mb-2" id="combo-display-4"></div>
    <div id="status-message-4" class="text-center text-zinc-500 mb-4 hidden"></div>
    <div class="text-center timer-display mb-4" id="timer-display-4"></div>

    <div class="flex flex-col sm:flex-row justify-center gap-8 mb-4">
        <div class="text-center">
            <p class="text-lg font-bold">Punches</p>
            <p id="punch-count-display-4" class="text-4xl font-extrabold text-orange-500">0</p>
        </div>
        <div class="text-center">
            <p class="text-lg font-bold">Movements</p>
            <p id="movement-count-display-4" class="text-4xl font-extrabold text-blue-500">0</p>
        </div>
    </div>

    <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8">
        <button id="start-button-4" class="level-button bg-orange-500 hover:bg-orange-400 hidden">Start</button>
        <button id="stop-button-4" class="level-button bg-red-600 hover:bg-red-500 hidden">Stop</button>
        <button id="back-button-4" class="level-button back-button">Back</button>
    </div>
    <div class="flex items-center justify-center gap-4 mt-4">
        <button id="speed-down-4" class="level-button vibrant-button">Slow Down</button>
        <span id="speed-display-4" class="text-xl font-bold">Speed: 1</span>
        <button id="speed-up-4" class="level-button vibrant-button">Speed Up</button>
    </div>
    <button id="save-button-4" class="level-button vibrant-button mt-4 hidden">Save Workout</button>
</div>

<!-- Level 5 Page Content -->
<div id="level-5-page" class="container hidden">
    <h2 class="text-4xl font-bold mb-4 text-center">Level 5</h2>
    <p class="text-center text-xl sm:text-2xl text-zinc-600 mb-8">Punches: 1-10 & Movements: Slip, Duck, Step, Pivot</p>
    <div id="difficulty-buttons-5" class="flex flex-col sm:flex-row justify-center gap-4 mb-8">
        <button class="level-button vibrant-button" data-difficulty="easy">Easy</button>
        <button class="level-button vibrant-button" data-difficulty="normal">Normal</button>
        <button class="level-button vibrant-button" data-difficulty="hard">Hard</button>
    </div>
    <div id="timer-buttons-5" class="grid grid-cols-3 gap-4 mb-8">
        <button class="level-button vibrant-button" data-timer="30">30 Sec</button>
        <button class="level-button vibrant-button" data-timer="90">1:30</button>
        <button class="level-button vibrant-button" data-timer="120">2:00</button>
        <button class="level-button vibrant-button" data-timer="150">2:30</button>
        <button class="level-button vibrant-button" data-timer="180">3:00</button>
        <button class="level-button vibrant-button" data-timer="open">Open</button>
    </div>
    <div class="text-center combo-display mb-2" id="combo-display-5"></div>
    <div id="status-message-5" class="text-center text-zinc-500 mb-4 hidden"></div>
    <div class="text-center timer-display mb-4" id="timer-display-5"></div>

    <div class="flex flex-col sm:flex-row justify-center gap-8 mb-4">
        <div class="text-center">
            <p class="text-lg font-bold">Punches</p>
            <p id="punch-count-display-5" class="text-4xl font-extrabold text-orange-500">0</p>
        </div>
        <div class="text-center">
            <p class="text-lg font-bold">Movements</p>
            <p id="movement-count-display-5" class="text-4xl font-extrabold text-blue-500">0</p>
        </div>
    </div>

    <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8">
        <button id="start-button-5" class="level-button bg-orange-500 hover:bg-orange-400 hidden">Start</button>
        <button id="stop-button-5" class="level-button bg-red-600 hover:bg-red-500 hidden">Stop</button>
        <button id="back-button-5" class="level-button back-button">Back</button>
    </div>
    <div class="flex items-center justify-center gap-4 mt-4">
        <button id="speed-down-5" class="level-button vibrant-button">Slow Down</button>
        <span id="speed-display-5" class="text-xl font-bold">Speed: 1</span>
        <button id="speed-up-5" class="level-button vibrant-button">Speed Up</button>
    </div>
    <button id="save-button-5" class="level-button vibrant-button mt-4 hidden">Save Workout</button>
</div>

<!-- Level 6 Page Content -->
<div id="level-6-page" class="container hidden">
    <h2 class="text-4xl font-bold mb-4 text-center">Level 6</h2>
    <p class="text-center text-xl sm:text-2xl text-zinc-600 mb-8">Punches: 1-16 & Movements: Slip, Duck, Step, Pivot</p>
    <div id="difficulty-buttons-6" class="flex flex-col sm:flex-row justify-center gap-4 mb-8">
        <button class="level-button vibrant-button" data-difficulty="easy">Easy</button>
        <button class="level-button vibrant-button" data-difficulty="normal">Normal</button>
        <button class="level-button vibrant-button" data-difficulty="hard">Hard</button>
    </div>
    <div id="timer-buttons-6" class="grid grid-cols-3 gap-4 mb-8">
        <button class="level-button vibrant-button" data-timer="30">30 Sec</button>
        <button class="level-button vibrant-button" data-timer="90">1:30</button>
        <button class="level-button vibrant-button" data-timer="120">2:00</button>
        <button class="level-button vibrant-button" data-timer="150">2:30</button>
        <button class="level-button vibrant-button" data-timer="180">3:00</button>
        <button class="level-button vibrant-button" data-timer="open">Open</button>
    </div>
    <div class="text-center combo-display mb-2" id="combo-display-6"></div>
    <div id="status-message-6" class="text-center text-zinc-500 mb-4 hidden"></div>
    <div class="text-center timer-display mb-4" id="timer-display-6"></div>

    <div class="flex flex-col sm:flex-row justify-center gap-8 mb-4">
        <div class="text-center">
            <p class="text-lg font-bold">Punches</p>
            <p id="punch-count-display-6" class="text-4xl font-extrabold text-orange-500">0</p>
        </div>
        <div class="text-center">
            <p class="text-lg font-bold">Movements</p>
            <p id="movement-count-display-6" class="text-4xl font-extrabold text-blue-500">0</p>
        </div>
    </div>

    <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8">
        <button id="start-button-6" class="level-button bg-orange-500 hover:bg-orange-400 hidden">Start</button>
        <button id="stop-button-6" class="level-button bg-red-600 hover:bg-red-500 hidden">Stop</button>
        <button id="back-button-6" class="level-button back-button">Back</button>
    </div>
    <div class="flex items-center justify-center gap-4 mt-4">
        <button id="speed-down-6" class="level-button vibrant-button">Slow Down</button>
        <span id="speed-display-6" class="text-xl font-bold">Speed: 1</span>
        <button id="speed-up-6" class="level-button vibrant-button">Speed Up</button>
    </div>
    <button id="save-button-6" class="level-button vibrant-button mt-4 hidden">Save Workout</button>
</div>

<!-- Level 7 Page Content -->
<div id="level-7-page" class="container hidden">
    <h2 class="text-4xl font-bold mb-4 text-center">Level 7</h2>
    <p class="text-center text-xl sm:text-2xl text-zinc-600 mb-8">Punches: 1-16 & Movements: Slip, Duck, Step, Pivot</p>
    <div id="difficulty-buttons-7" class="flex flex-col sm:flex-row justify-center gap-4 mb-8">
        <button class="level-button vibrant-button" data-difficulty="easy">Easy</button>
        <button class="level-button vibrant-button" data-difficulty="normal">Normal</button>
        <button class="level-button vibrant-button" data-difficulty="hard">Hard</button>
    </div>
    <div id="timer-buttons-7" class="grid grid-cols-3 gap-4 mb-8">
        <button class="level-button vibrant-button" data-timer="30">30 Sec</button>
        <button class="level-button vibrant-button" data-timer="90">1:30</button>
        <button class="level-button vibrant-button" data-timer="120">2:00</button>
        <button class="level-button vibrant-button" data-timer="150">2:30</button>
        <button class="level-button vibrant-button" data-timer="180">3:00</button>
        <button class="level-button vibrant-button" data-timer="open">Open</button>
    </div>
    <div class="text-center combo-display mb-2" id="combo-display-7"></div>
    <div id="status-message-7" class="text-center text-zinc-500 mb-4 hidden"></div>
    <div class="text-center timer-display mb-4" id="timer-display-7"></div>

    <div class="flex flex-col sm:flex-row justify-center gap-8 mb-4">
        <div class="text-center">
            <p class="text-lg font-bold">Punches</p>
            <p id="punch-count-display-7" class="text-4xl font-extrabold text-orange-500">0</p>
        </div>
        <div class="text-center">
            <p class="text-lg font-bold">Movements</p>
            <p id="movement-count-display-7" class="text-4xl font-extrabold text-blue-500">0</p>
        </div>
    </div>

    <div class="flex flex-col sm:flex-row justify-center gap-4 mt-8">
        <button id="start-button-7" class="level-button bg-orange-500 hover:bg-orange-400 hidden">Start</button>
        <button id="stop-button-7" class="level-button bg-red-600 hover:bg-red-500 hidden">Stop</button>
        <button id="back-button-7" class="level-button back-button">Back</button>
    </div>
    <div class="flex items-center justify-center gap-4 mt-4">
        <button id="speed-down-7" class="level-button vibrant-button">Slow Down</button>
        <span id="speed-display-7" class="text-xl font-bold">Speed: 1</span>
        <button id="speed-up-7" class="level-button vibrant-button">Speed Up</button>
    </div>
    <button id="save-button-7" class="level-button vibrant-button mt-4 hidden">Save Workout</button>
</div>

<!-- Custom Modal UI for messages -->
<div id="message-modal" class="modal hidden">
    <div class="modal-content text-center">
        <p id="modal-message" class="text-lg font-semibold mb-4"></p>
        <button id="close-modal-button" class="px-6 py-2 rounded-full vibrant-button">OK</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        const levels = 7;
        const levelButtonContainer = document.getElementById('level-button-container');
        const historyList = document.getElementById('history-list');
        const streakDisplay = document.getElementById('streak-display');
        const lastWorkoutDateDisplay = document.getElementById('last-workout-date');

        // --- PUNCH AND MOVEMENT DATA ---
        const levelData = {
            1: {
                punches: [1, 2, 3, 4, 5, 6],
                movements: [],
                easySequence: [1, 2, 3, 4, 5, 6]
            },
            2: {
                punches: [1, 2, 3, 4, 5, 6],
                movements: ['SlipRight', 'SlipLeft', 'DuckUnder'],
                easySequence: [1, 2, 3, 4, 5, 6, 'SlipRight', 'SlipLeft', 'DuckUnder']
            },
            3: {
                punches: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                movements: ['SlipRight', 'SlipLeft', 'DuckUnder'],
                easySequence: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 'SlipRight', 'SlipLeft', 'DuckUnder']
            },
            4: {
                punches: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                movements: ['Slip', 'Duck', 'Step'],
                easySequence: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 'Slip', 'Duck', 'Step']
            },
            5: {
                punches: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                movements: ['Slip', 'Duck', 'Step', 'Pivot'],
                easySequence: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 'Slip', 'Duck', 'Step', 'Pivot']
            },
            6: {
                punches: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16],
                movements: ['Slip', 'Duck', 'Step', 'Pivot'],
                easySequence: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 'Slip', 'Duck', 'Step', 'Pivot']
            },
            7: {
                punches: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16],
                movements: ['Slip', 'Duck', 'Step', 'Pivot'],
                easySequence: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 'Slip', 'Duck', 'Step', 'Pivot']
            }
        };

        // Global state variables
        let isWorkoutRunning = false;
        let selectedDifficulty = null;
        let selectedTimer = null;
        let punchIntervalId = null;
        let timerIntervalId = null;
        let timeLeft = 0;
        let currentLevel = null;
        let easyModeIndex = 0;
        let workoutStartedTime = null;
        let gameSpeed = 1;
        let punchCount = 0;
        let movementCount = 0;

        // Cache element references for each level
        const levelElements = {};
        for (let i = 1; i <= levels; i++) {
            levelElements[i] = {
                comboDisplay: document.getElementById(`combo-display-${i}`),
                timerDisplay: document.getElementById(`timer-display-${i}`),
                startButton: document.getElementById(`start-button-${i}`),
                stopButton: document.getElementById(`stop-button-${i}`),
                backButton: document.getElementById(`back-button-${i}`),
                saveButton: document.getElementById(`save-button-${i}`),
                difficultyButtons: document.querySelectorAll(`#difficulty-buttons-${i} .level-button`),
                timerButtons: document.querySelectorAll(`#timer-buttons-${i} .level-button`),
                statusMessage: document.getElementById(`status-message-${i}`),
                speedUpButton: document.getElementById(`speed-up-${i}`),
                speedDownButton: document.getElementById(`speed-down-${i}`),
                speedDisplay: document.getElementById(`speed-display-${i}`),
                punchCountDisplay: document.getElementById(`punch-count-display-${i}`),
                movementCountDisplay: document.getElementById(`movement-count-display-${i}`)
            };
        }

        // --- LOCAL STORAGE LOGIC ---
        function loadData() {
            try {
                const savedWorkouts = JSON.parse(localStorage.getItem('workouts') || '[]');
                const savedStreak = JSON.parse(localStorage.getItem('streak') || '{}');
                return { workouts: savedWorkouts, streak: savedStreak };
            } catch (e) {
                console.error("Failed to load data from localStorage:", e);
                return { workouts: [], streak: {} };
            }
        }

        function saveData(workouts, streak) {
            try {
                localStorage.setItem('workouts', JSON.stringify(workouts));
                localStorage.setItem('streak', JSON.stringify(streak));
            } catch (e) {
                console.error("Failed to save data to localStorage:", e);
            }
        }

        function updateUIWithData() {
            const { workouts, streak } = loadData();

            // Update streak display
            if (streak.dailyStreak) {
                streakDisplay.textContent = streak.dailyStreak;
                lastWorkoutDateDisplay.textContent = `Last workout: ${new Date(streak.lastWorkoutDate).toDateString()}`;
            } else {
                streakDisplay.textContent = '0';
                lastWorkoutDateDisplay.textContent = 'Start a workout!';
            }

            // Update workout history
            historyList.innerHTML = '';
            // Sort workouts by timestamp in descending order in memory
            workouts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const recentWorkouts = workouts.slice(0, 5); // Display only the 5 most recent

            if (recentWorkouts.length === 0) {
                historyList.innerHTML = '<p class="text-center text-gray-500">No workouts saved yet.</p>';
            } else {
                recentWorkouts.forEach((workout) => {
                    const workoutDate = new Date(workout.timestamp).toLocaleString();
                    const workoutItem = document.createElement('div');
                    workoutItem.className = 'bg-gray-200 p-2 my-2 rounded-lg';
                    workoutItem.innerHTML = `
                        <p class="font-bold">Level ${workout.level} (${workout.difficulty})</p>
                        <p class="text-sm text-gray-700">Duration: ${formatTime(workout.duration)}</p>
                        <p class="text-sm text-gray-700">Punches: ${workout.punches}, Movements: ${workout.movements}</p>
                        <p class="text-xs text-gray-500">Date: ${workoutDate}</p>
                    `;
                    historyList.appendChild(workoutItem);
                });
            }
        }

        async function saveWorkout() {
            if (!workoutStartedTime) return;

            const duration = Math.floor((Date.now() - workoutStartedTime) / 1000);
            const workoutData = {
                level: currentLevel,
                difficulty: selectedDifficulty,
                duration: duration,
                punches: punchCount,
                movements: movementCount,
                timestamp: new Date().toISOString() // Use ISO string for saving dates
            };

            const { workouts, streak } = loadData();
            workouts.push(workoutData);

            // Calculate and update streak
            let newStreak = streak.dailyStreak || 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (streak.lastWorkoutDate) {
                const lastDateOnly = new Date(streak.lastWorkoutDate);
                lastDateOnly.setHours(0, 0, 0, 0);
                const dayDifference = Math.floor((today - lastDateOnly) / (1000 * 60 * 60 * 24));

                if (dayDifference === 1) {
                    newStreak += 1;
                } else if (dayDifference > 1) {
                    newStreak = 1;
                }
            } else {
                newStreak = 1;
            }

            const updatedStreak = {
                dailyStreak: newStreak,
                lastWorkoutDate: new Date().toISOString()
            };

            saveData(workouts, updatedStreak);
            showMessageModal("Workout saved successfully!");
            updateUIWithData();
        }

        // --- UI LOGIC ---
        function showMessageModal(message) {
            const modal = document.getElementById('message-modal');
            const modalMessage = document.getElementById('modal-message');
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            document.getElementById('close-modal-button').onclick = () => {
                modal.classList.add('hidden');
            };
        }

        function showPage(pageId) {
            document.querySelectorAll('.container').forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
        }

        function updateLevelDisplay(level) {
            const elements = levelElements[level];
            elements.comboDisplay.textContent = '';
            elements.timerDisplay.textContent = formatTime(selectedTimer);
            elements.punchCountDisplay.textContent = '0';
            elements.movementCountDisplay.textContent = '0';
            elements.statusMessage.classList.add('hidden');
            elements.saveButton.classList.add('hidden');
            elements.startButton.classList.remove('hidden');
            elements.stopButton.classList.add('hidden');

            // Reset selected buttons
            elements.difficultyButtons.forEach(btn => btn.classList.remove('button-selected'));
            elements.timerButtons.forEach(btn => btn.classList.remove('button-selected'));

            // Reset state
            isWorkoutRunning = false;
            selectedDifficulty = null;
            selectedTimer = null;
            punchCount = 0;
            movementCount = 0;
            easyModeIndex = 0;
        }

        // --- WORKOUT LOGIC ---
        function startWorkout() {
            if (isWorkoutRunning) return;

            // Check if difficulty and timer are selected
            if (!selectedDifficulty || !selectedTimer) {
                showMessageModal("Please select a difficulty and a timer.");
                return;
            }

            isWorkoutRunning = true;
            workoutStartedTime = Date.now();
            const elements = levelElements[currentLevel];
            elements.startButton.classList.add('hidden');
            elements.stopButton.classList.remove('hidden');
            elements.saveButton.classList.add('hidden');
            elements.statusMessage.classList.add('hidden');
            elements.punchCountDisplay.textContent = '0';
            elements.movementCountDisplay.textContent = '0';
            punchCount = 0;
            movementCount = 0;

            // Start combo interval
            const punchDelay = 3000 / gameSpeed;
            punchIntervalId = setInterval(generateCombo, punchDelay);

            // Start timer interval for non-open modes
            if (selectedTimer !== 'open') {
                timeLeft = parseInt(selectedTimer);
                elements.timerDisplay.textContent = formatTime(timeLeft);
                timerIntervalId = setInterval(() => {
                    timeLeft--;
                    elements.timerDisplay.textContent = formatTime(timeLeft);
                    if (timeLeft <= 0) {
                        stopWorkout("Workout Finished!");
                    }
                }, 1000);
            } else {
                elements.timerDisplay.textContent = 'Open';
            }
        }

        function stopWorkout(message = "Workout Stopped.") {
            isWorkoutRunning = false;
            clearInterval(punchIntervalId);
            clearInterval(timerIntervalId);
            const elements = levelElements[currentLevel];
            elements.startButton.classList.remove('hidden');
            elements.stopButton.classList.add('hidden');
            elements.saveButton.classList.remove('hidden');
            elements.statusMessage.textContent = message;
            elements.statusMessage.classList.remove('hidden');
        }

        function generateCombo() {
            const elements = levelElements[currentLevel];
            const data = levelData[currentLevel];
            let combo;

            if (selectedDifficulty === 'easy') {
                combo = data.easySequence[easyModeIndex];
                easyModeIndex = (easyModeIndex + 1) % data.easySequence.length;
            } else {
                const punchCount = selectedDifficulty === 'normal' ? 1 : Math.floor(Math.random() * 3) + 1;
                const movementChance = selectedDifficulty === 'hard' ? 0.5 : 0.2;
                let comboArray = [];

                for (let i = 0; i < punchCount; i++) {
                    comboArray.push(data.punches[Math.floor(Math.random() * data.punches.length)]);
                }

                if (Math.random() < movementChance && data.movements.length > 0) {
                    const movement = data.movements[Math.floor(Math.random() * data.movements.length)];
                    comboArray.push(movement);
                }
                combo = comboArray.join(' - ');
            }

            elements.comboDisplay.textContent = combo;

            // Update counts
            const punchesInCombo = combo.toString().split(' - ').filter(item => !isNaN(item));
            punchCount += punchesInCombo.length;

            const movementsInCombo = combo.toString().split(' - ').filter(item => isNaN(item) || !/^\d+$/.test(item));
            movementCount += movementsInCombo.length;

            elements.punchCountDisplay.textContent = punchCount;
            elements.movementCountDisplay.textContent = movementCount;
        }

        // --- HELPERS ---
        function formatTime(seconds) {
            if (seconds === 'open') return 'Open';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        // --- EVENT LISTENERS ---

        // Dynamically generate level buttons
        for (let i = 1; i <= levels; i++) {
            const button = document.createElement('button');
            button.className = 'level-button vibrant-button';
            button.textContent = `Level ${i}`;
            button.dataset.level = i;
            levelButtonContainer.appendChild(button);

            button.addEventListener('click', () => {
                currentLevel = i;
                showPage(`level-${i}-page`);
                updateLevelDisplay(i);
            });
        }

        // Attach event listeners for each level page
        for (let i = 1; i <= levels; i++) {
            const elements = levelElements[i];

            elements.difficultyButtons.forEach(button => {
                button.addEventListener('click', () => {
                    elements.difficultyButtons.forEach(btn => btn.classList.remove('button-selected'));
                    button.classList.add('button-selected');
                    selectedDifficulty = button.dataset.difficulty;
                    elements.startButton.classList.remove('hidden');
                    stopWorkout("Difficulty selected. Choose a timer and press Start.");
                });
            });

            elements.timerButtons.forEach(button => {
                button.addEventListener('click', () => {
                    elements.timerButtons.forEach(btn => btn.classList.remove('button-selected'));
                    button.classList.add('button-selected');
                    selectedTimer = button.dataset.timer;
                    elements.startButton.classList.remove('hidden');
                    stopWorkout("Timer selected. Choose a difficulty and press Start.");
                });
            });

            elements.startButton.addEventListener('click', startWorkout);
            elements.stopButton.addEventListener('click', () => stopWorkout());
            elements.saveButton.addEventListener('click', saveWorkout);
            elements.backButton.addEventListener('click', () => {
                stopWorkout();
                showPage('main-menu-page');
            });

            elements.speedUpButton.addEventListener('click', () => {
                if (gameSpeed < 3) {
                    gameSpeed += 0.5;
                    elements.speedDisplay.textContent = `Speed: ${gameSpeed}`;
                    if (isWorkoutRunning) {
                        clearInterval(punchIntervalId);
                        const punchDelay = 3000 / gameSpeed;
                        punchIntervalId = setInterval(generateCombo, punchDelay);
                    }
                }
            });

            elements.speedDownButton.addEventListener('click', () => {
                if (gameSpeed > 0.5) {
                    gameSpeed -= 0.5;
                    elements.speedDisplay.textContent = `Speed: ${gameSpeed}`;
                    if (isWorkoutRunning) {
                        clearInterval(punchIntervalId);
                        const punchDelay = 3000 / gameSpeed;
                        punchIntervalId = setInterval(generateCombo, punchDelay);
                    }
                }
            });
        }

        // Initial load of data
        updateUIWithData();
    });
</script>
</body>
</html>
